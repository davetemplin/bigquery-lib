CREATE OR REPLACE FUNCTION udf.parse_url(url STRING)
RETURNS STRUCT<
  scheme STRING,
  authority STRING,
  domain STRING,
  username STRING,
  password STRING,
  port STRING,
  path STRING,
  query STRING,
  fragment STRING,
  error STRING
>
LANGUAGE js
AS
"""var rollup=function(){\"use strict\";\n/*! https://mths.be/punycode v1.4.1 by @mathias */var t=2147483647,e=36,r=1,n=26,o=38,a=700,s=72,h=128,u=\"-\",i=/[^\\x20-\\x7E]/,l=/[\\x2E\\u3002\\uFF0E\\uFF61]/g,p={overflow:\"Overflow: input needs wider integers to process\",\"not-basic\":\"Illegal input >= 0x80 (not a basic code point)\",\"invalid-input\":\"Invalid input\"},c=e-r,f=Math.floor,m=String.fromCharCode;function v(t){throw new RangeError(p[t])}function g(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function y(t,r,s){var h=0;for(t=s?f(t/a):t>>1,t+=f(t/r);t>c*n>>1;h+=e)t=f(t/c);return f(h+(c+1)*t/(t+o))}function d(o){return function(t,e){var r=t.split(\"@\"),n=\"\";r.length>1&&(n=r[0]+\"@\",t=r[1]);var o=function(t,e){for(var r=t.length,n=[];r--;)n[r]=e(t[r]);return n}((t=t.replace(l,\".\")).split(\".\"),e).join(\".\");return n+o}(o,(function(o){return i.test(o)?\"xn--\"+function(o){var a,i,l,p,c,d,b,j,O,w,x,q,C,A,I,R=[];for(q=(o=function(t){for(var e,r,n=[],o=0,a=t.length;o<a;)(e=t.charCodeAt(o++))>=55296&&e<=56319&&o<a?56320==(64512&(r=t.charCodeAt(o++)))?n.push(((1023&e)<<10)+(1023&r)+65536):(n.push(e),o--):n.push(e);return n}(o)).length,a=h,i=0,c=s,d=0;d<q;++d)(x=o[d])<128&&R.push(m(x));for(l=p=R.length,p&&R.push(u);l<q;){for(b=t,d=0;d<q;++d)(x=o[d])>=a&&x<b&&(b=x);for(b-a>f((t-i)/(C=l+1))&&v(\"overflow\"),i+=(b-a)*C,a=b,d=0;d<q;++d)if((x=o[d])<a&&++i>t&&v(\"overflow\"),x==a){for(j=i,O=e;!(j<(w=O<=c?r:O>=c+n?n:O-c));O+=e)I=j-w,A=e-w,R.push(m(g(w+I%A,0))),j=f(I/A);R.push(m(g(j,0))),c=y(i,C,l==p),i=0,++l}++i,++a}return R.join(\"\")}(o):o}))}var b=(\"undefined\"!=typeof global?global:\"undefined\"!=typeof self?self:\"undefined\"!=typeof window?window:{}).performance||{};b.now||b.mozNow||b.msNow||b.oNow||b.webkitNow;function j(t){return null===t}function O(t){return\"string\"==typeof t}function w(t){return\"object\"==typeof t&&null!==t}function x(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var q=Array.isArray||function(t){return\"[object Array]\"===Object.prototype.toString.call(t)};function C(t){switch(typeof t){case\"string\":return t;case\"boolean\":return t?\"true\":\"false\";case\"number\":return isFinite(t)?t:\"\";default:return\"\"}}function A(t,e){if(t.map)return t.map(e);for(var r=[],n=0;n<t.length;n++)r.push(e(t[n],n));return r}var I=Object.keys||function(t){var e=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.push(r);return e};function R(t,e,r,n){e=e||\"&\",r=r||\"=\";var o={};if(\"string\"!=typeof t||0===t.length)return o;var a=/\\+/g;t=t.split(e);var s=1e3;n&&\"number\"==typeof n.maxKeys&&(s=n.maxKeys);var h=t.length;s>0&&h>s&&(h=s);for(var u=0;u<h;++u){var i,l,p,c,f=t[u].replace(a,\"%20\"),m=f.indexOf(r);m>=0?(i=f.substr(0,m),l=f.substr(m+1)):(i=f,l=\"\"),p=decodeURIComponent(i),c=decodeURIComponent(l),x(o,p)?q(o[p])?o[p].push(c):o[p]=[o[p],c]:o[p]=c}return o}var U={parse:T,resolve:function(t,e){return T(t,!1,!0).resolve(e)},resolveObject:function(t,e){return t?T(t,!1,!0).resolveObject(e):e},format:function(t){O(t)&&(t=B({},t));return D(t)},Url:k};function k(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var E=/^([a-z0-9.+-]+:)/i,F=/:[0-9]*$/,z=/^(\\/\\/?(?!\\/)[^\\?\\s]*)(\\?[^\\s]*)?$/,N=[\"{\",\"}\",\"|\",\"\\\\\",\"^\",\"`\"].concat([\"<\",\">\",'\"',\"`\",\" \",\"\\r\",\"\\n\",\"\\t\"]),$=[\"'\"].concat(N),P=[\"%\",\"/\",\"?\",\";\",\"#\"].concat($),K=[\"/\",\"?\",\"#\"],L=255,S=/^[+a-z0-9A-Z_-]{0,63}$/,Z=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,_={javascript:!0,\"javascript:\":!0},H={javascript:!0,\"javascript:\":!0},M={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,\"http:\":!0,\"https:\":!0,\"ftp:\":!0,\"gopher:\":!0,\"file:\":!0};function T(t,e,r){if(t&&w(t)&&t instanceof k)return t;var n=new k;return n.parse(t,e,r),n}function B(t,e,r,n){if(!O(e))throw new TypeError(\"Parameter 'url' must be a string, not \"+typeof e);var o=e.indexOf(\"?\"),a=-1!==o&&o<e.indexOf(\"#\")?\"?\":\"#\",s=e.split(a);s[0]=s[0].replace(/\\\\/g,\"/\");var h=e=s.join(a);if(h=h.trim(),!n&&1===e.split(\"#\").length){var u=z.exec(h);if(u)return t.path=h,t.href=h,t.pathname=u[1],u[2]?(t.search=u[2],t.query=r?R(t.search.substr(1)):t.search.substr(1)):r&&(t.search=\"\",t.query={}),t}var i,l,p,c,f=E.exec(h);if(f){var m=(f=f[0]).toLowerCase();t.protocol=m,h=h.substr(f.length)}if(n||f||h.match(/^\\/\\/[^@\\/]+@[^@\\/]+/)){var v=\"//\"===h.substr(0,2);!v||f&&H[f]||(h=h.substr(2),t.slashes=!0)}if(!H[f]&&(v||f&&!M[f])){var g,y,b=-1;for(i=0;i<K.length;i++)-1!==(l=h.indexOf(K[i]))&&(-1===b||l<b)&&(b=l);for(-1!==(y=-1===b?h.lastIndexOf(\"@\"):h.lastIndexOf(\"@\",b))&&(g=h.slice(0,y),h=h.slice(y+1),t.auth=decodeURIComponent(g)),b=-1,i=0;i<P.length;i++)-1!==(l=h.indexOf(P[i]))&&(-1===b||l<b)&&(b=l);-1===b&&(b=h.length),t.host=h.slice(0,b),h=h.slice(b),G(t),t.hostname=t.hostname||\"\";var j=\"[\"===t.hostname[0]&&\"]\"===t.hostname[t.hostname.length-1];if(!j){var w=t.hostname.split(/\\./);for(i=0,p=w.length;i<p;i++){var x=w[i];if(x&&!x.match(S)){for(var q=\"\",C=0,A=x.length;C<A;C++)x.charCodeAt(C)>127?q+=\"x\":q+=x[C];if(!q.match(S)){var I=w.slice(0,i),U=w.slice(i+1),k=x.match(Z);k&&(I.push(k[1]),U.unshift(k[2])),U.length&&(h=\"/\"+U.join(\".\")+h),t.hostname=I.join(\".\");break}}}}t.hostname.length>L?t.hostname=\"\":t.hostname=t.hostname.toLowerCase(),j||(t.hostname=d(t.hostname)),c=t.port?\":\"+t.port:\"\";var F=t.hostname||\"\";t.host=F+c,t.href+=t.host,j&&(t.hostname=t.hostname.substr(1,t.hostname.length-2),\"/\"!==h[0]&&(h=\"/\"+h))}if(!_[m])for(i=0,p=$.length;i<p;i++){var N=$[i];if(-1!==h.indexOf(N)){var T=encodeURIComponent(N);T===N&&(T=escape(N)),h=h.split(N).join(T)}}var B=h.indexOf(\"#\");-1!==B&&(t.hash=h.substr(B),h=h.slice(0,B));var J=h.indexOf(\"?\");if(-1!==J?(t.search=h.substr(J),t.query=h.substr(J+1),r&&(t.query=R(t.query)),h=h.slice(0,J)):r&&(t.search=\"\",t.query={}),h&&(t.pathname=h),M[m]&&t.hostname&&!t.pathname&&(t.pathname=\"/\"),t.pathname||t.search){c=t.pathname||\"\";var Q=t.search||\"\";t.path=c+Q}return t.href=D(t),t}function D(t){var e=t.auth||\"\";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,\":\"),e+=\"@\");var r,n,o,a,s=t.protocol||\"\",h=t.pathname||\"\",u=t.hash||\"\",i=!1,l=\"\";t.host?i=e+t.host:t.hostname&&(i=e+(-1===t.hostname.indexOf(\":\")?t.hostname:\"[\"+this.hostname+\"]\"),t.port&&(i+=\":\"+t.port)),t.query&&w(t.query)&&Object.keys(t.query).length&&(r=t.query,n=n||\"&\",o=o||\"=\",null===r&&(r=void 0),l=\"object\"==typeof r?A(I(r),(function(t){var e=encodeURIComponent(C(t))+o;return q(r[t])?A(r[t],(function(t){return e+encodeURIComponent(C(t))})).join(n):e+encodeURIComponent(C(r[t]))})).join(n):a?encodeURIComponent(C(a))+o+encodeURIComponent(C(r)):\"\");var p=t.search||l&&\"?\"+l||\"\";return s&&\":\"!==s.substr(-1)&&(s+=\":\"),t.slashes||(!s||M[s])&&!1!==i?(i=\"//\"+(i||\"\"),h&&\"/\"!==h.charAt(0)&&(h=\"/\"+h)):i||(i=\"\"),u&&\"#\"!==u.charAt(0)&&(u=\"#\"+u),p&&\"?\"!==p.charAt(0)&&(p=\"?\"+p),s+i+(h=h.replace(/[?#]/g,(function(t){return encodeURIComponent(t)})))+(p=p.replace(\"#\",\"%23\"))+u}function G(t){var e=t.host,r=F.exec(e);r&&(\":\"!==(r=r[0])&&(t.port=r.substr(1)),e=e.substr(0,e.length-r.length)),e&&(t.hostname=e)}return k.prototype.parse=function(t,e,r){return B(this,t,e,r)},k.prototype.format=function(){return D(this)},k.prototype.resolve=function(t){return this.resolveObject(T(t,!1,!0)).format()},k.prototype.resolveObject=function(t){if(O(t)){var e=new k;e.parse(t,!1,!0),t=e}for(var r,n=new k,o=Object.keys(this),a=0;a<o.length;a++){var s=o[a];n[s]=this[s]}if(n.hash=t.hash,\"\"===t.href)return n.href=n.format(),n;if(t.slashes&&!t.protocol){for(var h=Object.keys(t),u=0;u<h.length;u++){var i=h[u];\"protocol\"!==i&&(n[i]=t[i])}return M[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname=\"/\"),n.href=n.format(),n}if(t.protocol&&t.protocol!==n.protocol){if(!M[t.protocol]){for(var l=Object.keys(t),p=0;p<l.length;p++){var c=l[p];n[c]=t[c]}return n.href=n.format(),n}if(n.protocol=t.protocol,t.host||H[t.protocol])n.pathname=t.pathname;else{for(r=(t.pathname||\"\").split(\"/\");r.length&&!(t.host=r.shift()););t.host||(t.host=\"\"),t.hostname||(t.hostname=\"\"),\"\"!==r[0]&&r.unshift(\"\"),r.length<2&&r.unshift(\"\"),n.pathname=r.join(\"/\")}if(n.search=t.search,n.query=t.query,n.host=t.host||\"\",n.auth=t.auth,n.hostname=t.hostname||t.host,n.port=t.port,n.pathname||n.search){var f=n.pathname||\"\",m=n.search||\"\";n.path=f+m}return n.slashes=n.slashes||t.slashes,n.href=n.format(),n}var v,g=n.pathname&&\"/\"===n.pathname.charAt(0),y=t.host||t.pathname&&\"/\"===t.pathname.charAt(0),d=y||g||n.host&&t.pathname,b=d,w=n.pathname&&n.pathname.split(\"/\")||[],x=n.protocol&&!M[n.protocol];if(r=t.pathname&&t.pathname.split(\"/\")||[],x&&(n.hostname=\"\",n.port=null,n.host&&(\"\"===w[0]?w[0]=n.host:w.unshift(n.host)),n.host=\"\",t.protocol&&(t.hostname=null,t.port=null,t.host&&(\"\"===r[0]?r[0]=t.host:r.unshift(t.host)),t.host=null),d=d&&(\"\"===r[0]||\"\"===w[0])),y)n.host=t.host||\"\"===t.host?t.host:n.host,n.hostname=t.hostname||\"\"===t.hostname?t.hostname:n.hostname,n.search=t.search,n.query=t.query,w=r;else if(r.length)w||(w=[]),w.pop(),w=w.concat(r),n.search=t.search,n.query=t.query;else if(null!=t.search)return x&&(n.hostname=n.host=w.shift(),(v=!!(n.host&&n.host.indexOf(\"@\")>0)&&n.host.split(\"@\"))&&(n.auth=v.shift(),n.host=n.hostname=v.shift())),n.search=t.search,n.query=t.query,j(n.pathname)&&j(n.search)||(n.path=(n.pathname?n.pathname:\"\")+(n.search?n.search:\"\")),n.href=n.format(),n;if(!w.length)return n.pathname=null,n.search?n.path=\"/\"+n.search:n.path=null,n.href=n.format(),n;for(var q=w.slice(-1)[0],C=(n.host||t.host||w.length>1)&&(\".\"===q||\"..\"===q)||\"\"===q,A=0,I=w.length;I>=0;I--)\".\"===(q=w[I])?w.splice(I,1):\"..\"===q?(w.splice(I,1),A++):A&&(w.splice(I,1),A--);if(!d&&!b)for(;A--;A)w.unshift(\"..\");!d||\"\"===w[0]||w[0]&&\"/\"===w[0].charAt(0)||w.unshift(\"\"),C&&\"/\"!==w.join(\"/\").substr(-1)&&w.push(\"\");var R=\"\"===w[0]||w[0]&&\"/\"===w[0].charAt(0);return x&&(n.hostname=n.host=R?\"\":w.length?w.shift():\"\",(v=!!(n.host&&n.host.indexOf(\"@\")>0)&&n.host.split(\"@\"))&&(n.auth=v.shift(),n.host=n.hostname=v.shift())),(d=d||n.host&&w.length)&&!R&&w.unshift(\"\"),w.length?n.pathname=w.join(\"/\"):(n.pathname=null,n.path=null),j(n.pathname)&&j(n.search)||(n.path=(n.pathname?n.pathname:\"\")+(n.search?n.search:\"\")),n.auth=t.auth||n.auth,n.slashes=n.slashes||t.slashes,n.href=n.format(),n},k.prototype.parseHost=function(){return G(this)},U}();
try {
    const result = rollup.parse(url, true);
    return {
        scheme: result.protocol ? result.protocol.slice(0, -1) : undefined,
        authority: result.host,
        domain: result.hostname,
        username: result.auth ? result.auth.split(':')[0] : undefined,
        password: result.auth ? result.auth.split(':')[1] : undefined,
        port: result.port,
        path: result.pathname,
        query: result.search,
        fragment: result.hash
    };
}
catch (err) {
    return {error: err.message};
}
""";
